<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HotTrack SAAS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: #111827; color: #f3f4f6; }
        .card { background-color: #1f2937; border: 1px solid #374151; }
        .form-input { background-color: #374151; border: 1px solid #4b5563; }
        .btn { background-color: #3b82f6; color: white; transition: background-color 0.2s; }
        .btn:hover { background-color: #2563eb; }
        .btn-red { background-color: #ef4444; }
        .btn-red:hover { background-color: #dc2626; }
        .modal { display: none; }
        .modal.active { display: flex; align-items: center; justify-content: center; position: fixed; z-index: 50; inset: 0; background-color: rgba(0,0,0,0.5); backdrop-filter: blur(4px); }
    </style>
</head>
<body>
    <div id="app"></div>

    <script>
    const App = {
        state: {
            API_BASE_URL: 'https://hottrack.vercel.app', // CONFIRME SUA URL DA VERCEL AQUI
            token: null,
            data: { pixels: [], bots: [], pressels: [], settings: {} },
        },

        async init() {
            this.state.token = localStorage.getItem('hottrack_token');
            const appContainer = document.getElementById('app');
            if (this.state.token) {
                try {
                    appContainer.innerHTML = `<p class="text-center p-8">Carregando...</p>`;
                    this.state.data = await this.apiRequest('/api/dashboard/data');
                    appContainer.innerHTML = this.templates.presselManager();
                } catch (e) {
                    this.logout();
                }
            } else {
                appContainer.innerHTML = this.templates.login();
            }
            this.addEventListeners();
        },

        templates: {
            login() { /* ... HTML do formulário de login ... */ },
            register() { /* ... HTML do formulário de registro ... */ },
            presselManager() {
                const { pixels, bots, pressels } = App.state.data;
                const botOptions = bots.map(b => `<option value="${b.id}">${b.bot_name}</option>`).join('');
                const pixelCheckboxes = pixels.map(p => `<label class="flex items-center space-x-2"><input type="checkbox" name="pixel_ids" value="${p.id}"><span>${p.account_name}</span></label>`).join('');
                const presselList = pressels.map(pr => `
                    <div class="card p-3 flex justify-between items-center text-sm">
                        <span>${pr.name}</span>
                        <span class="text-gray-400">Bot: ${pr.bot_name}</span>
                    </div>`).join('');

                return `
                <div class="max-w-7xl mx-auto p-4 lg:p-8 grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-1 space-y-8">
                        <div class="card p-6 rounded-lg">
                            <h2 class="text-xl font-bold mb-4">1. Gerenciar Pixels</h2>
                            <form id="pixelForm" class="space-y-3">
                                <input name="account_name" placeholder="Nome do Pixel (Ex: Produto Y)" class="form-input w-full p-2 rounded" required>
                                <input name="pixel_id" placeholder="ID do Pixel da Meta" class="form-input w-full p-2 rounded" required>
                                <textarea name="meta_api_token" placeholder="Token da API de Conversões" class="form-input w-full p-2 rounded" rows="2" required></textarea>
                                <button type="submit" class="btn w-full p-2 rounded">Adicionar Pixel</button>
                            </form>
                            <div id="pixel-list" class="mt-4 space-y-2">${pixels.map(p => `<div class="text-sm p-2 bg-gray-800 rounded">${p.account_name}</div>`).join('')}</div>
                        </div>
                        <div class="card p-6 rounded-lg">
                            <h2 class="text-xl font-bold mb-4">2. Gerenciar Bots</h2>
                            <form id="botForm" class="space-y-3">
                                <input name="bot_name" placeholder="Username do Bot (sem @)" class="form-input w-full p-2 rounded" required>
                                <input name="bot_token" placeholder="Token do Bot (do BotFather)" class="form-input w-full p-2 rounded" required>
                                <button type="submit" class="btn w-full p-2 rounded">Adicionar Bot</button>
                            </form>
                            <div id="bot-list" class="mt-4 space-y-2">${bots.map(b => `<div class="text-sm p-2 bg-gray-800 rounded">${b.bot_name}</div>`).join('')}</div>
                        </div>
                    </div>
                    <div class="lg:col-span-2 space-y-8">
                        <div class="card p-6 rounded-lg">
                            <h2 class="text-xl font-bold mb-4">3. Criar Nova Pressel</h2>
                            <form id="presselForm" class="space-y-4">
                                <input name="name" placeholder="Nome da Pressel (Ex: Campanha Black Friday)" class="form-input w-full p-2 rounded" required>
                                <input name="white_page_url" type="url" placeholder="URL da Página Branca (Fallback)" class="form-input w-full p-2 rounded" required>
                                <select name="bot_id" class="form-input w-full p-2 rounded" required>${botOptions}</select>
                                <div class="card p-3"><p class="font-semibold mb-2">Selecione os Pixels:</p><div class="space-y-2">${pixelCheckboxes}</div></div>
                                <button type="submit" class="btn w-full p-3 rounded text-base font-bold">Gerar Código da Pressel</button>
                            </form>
                        </div>
                        <div class="card p-6 rounded-lg">
                            <h2 class="text-xl font-bold mb-4">Pressels Criadas</h2>
                            <div id="pressel-list" class="space-y-3">${presselList}</div>
                        </div>
                    </div>
                </div>
                <div class="text-center mt-4"><button id="logoutButton" class="btn btn-red py-2 px-4 rounded">Sair</button></div>`;
            },
            modal(title, content) {
                return `
                <div id="modal" class="modal active">
                    <div class="card p-6 rounded-lg w-full max-w-2xl">
                        <h2 class="text-xl font-bold mb-4">${title}</h2>
                        ${content}
                        <button id="closeModalBtn" class="btn mt-4 w-full p-2 rounded">Fechar</button>
                    </div>
                </div>`;
            }
        },

        addEventListeners() { /* ... (código completo na próxima seção) ... */ },
        async apiRequest(endpoint, method = 'GET', body = null) { /* ... (código completo na próxima seção) ... */ },
        // ... (restante das funções)
    };

    // --- CÓDIGO COMPLETO PARA AS FUNÇÕES DO APP ---
    App.addEventListeners = function() {
        document.body.addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const data = Object.fromEntries(new FormData(form).entries());

            if (form.id === 'loginForm') {
                await this.login(data.email, data.password);
            }
            if (form.id === 'registerForm') {
                await this.register(data.name, data.email, data.password);
            }
            if (form.id === 'pixelForm') {
                const newPixel = await this.apiRequest('/api/pixels', 'POST', data);
                this.state.data.pixels.unshift(newPixel);
                this.init(); // Recarrega tudo
            }
            if (form.id === 'botForm') {
                const newBot = await this.apiRequest('/api/bots', 'POST', data);
                this.state.data.bots.unshift(newBot);
                this.init(); // Recarrega tudo
            }
            if (form.id === 'presselForm') {
                const pixel_ids = Array.from(form.querySelectorAll('input[name="pixel_ids"]:checked')).map(cb => cb.value);
                if (pixel_ids.length === 0) return alert('Selecione ao menos um pixel.');
                
                const payload = { ...data, pixel_ids };
                const newPressel = await this.apiRequest('/api/pressels', 'POST', payload);
                this.generatePresselCode(newPressel);
            }
        });
        document.body.addEventListener('click', (e) => {
            if (e.target.id === 'showRegister') document.getElementById('app').innerHTML = this.templates.auth('register');
            if (e.target.id === 'showLogin') document.getElementById('app').innerHTML = this.templates.auth('login');
            if (e.target.id === 'logoutButton') this.logout();
            if (e.target.id === 'closeModalBtn') document.getElementById('modal-container').innerHTML = '';
        });
    };

    App.apiRequest = async function(endpoint, method = 'GET', body = null) {
        const headers = { 'Content-Type': 'application/json' };
        if (this.state.token) { headers['Authorization'] = `Bearer ${this.state.token}`; }
        const options = { method, headers };
        if (body) { options.body = JSON.stringify(body); }
        try {
            const response = await fetch(`${this.state.API_BASE_URL}${endpoint}`, options);
            if (response.status === 204) return null;
            const data = await response.json();
            if (!response.ok) throw new Error(data.message || 'Erro');
            return data;
        } catch (error) {
            alert(`Erro: ${error.message}`);
            if (error.message.includes('inválido')) this.logout();
            throw error;
        }
    };

    App.login = async function(email, password) {
        try {
            const data = await this.apiRequest('/api/sellers/login', 'POST', { email, password });
            this.state.token = data.token;
            localStorage.setItem('hottrack_token', data.token);
            await this.init();
        } catch (e) {}
    };

    App.register = async function(name, email, password) {
        try {
            await this.apiRequest('/api/sellers/register', 'POST', { name, email, password });
            alert('Cadastro realizado! Faça o login.');
            document.getElementById('app').innerHTML = this.templates.auth('login');
        } catch (e) {}
    };

    App.logout = function() {
        this.state.token = null;
        localStorage.removeItem('hottrack_token');
        this.init();
    };

    App.generatePresselCode = function(pressel) {
        const { settings, pixels } = this.state.data;
        const selectedPixels = pixels.filter(p => pressel.pixel_ids.includes(p.id.toString()));
        const pixelsToTrackString = JSON.stringify(selectedPixels.map(p => ({ id: p.pixel_id })), null, 2);
        const noscriptPixelsString = selectedPixels.map(p => `<img height="1" width="1" style="display:none" src="https://www.facebook.com/tr?id=${p.pixel_id}&ev=PageView&noscript=1"/>`).join('\\n    ');
        
        const code = `<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>${pressel.name}</title>
    <script>
        const API_BASE_URL = '${this.state.API_BASE_URL}';
        const SELLER_API_KEY = '${settings.api_key}';
        const PRESSEL_ID = ${pressel.id};
        const TELEGRAM_USERNAME = '${pressel.bot_name}';
        const WHITE_PAGE_URL = '${pressel.white_page_url}';
        const PIXELS_TO_TRACK = ${pixelsToTrackString};
        
        const isBot = () => /bot|facebook|crawler|spider/i.test(navigator.userAgent);
        const isMobile = () => /android|iphone|ipad|ipod/i.test(navigator.userAgent);
        
        async function handleRedirect() {
            if (isBot() || !isMobile()) {
                window.location.replace(WHITE_PAGE_URL);
                return;
            }
            try {
                const response = await fetch(\`\${API_BASE_URL}/api/registerClick\`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sellerApiKey: SELLER_API_KEY, presselId: PRESSEL_ID })
                });
                const data = await response.json();
                if (response.ok && data.status === 'success') {
                    window.location.replace(\`https://t.me/\${TELEGRAM_USERNAME}?start=\${data.click_id}\`);
                } else {
                    window.location.replace(WHITE_PAGE_URL);
                }
            } catch (error) {
                window.location.replace(WHITE_PAGE_URL);
            }
        }
        handleRedirect();
    <\/script>
    <script>
        !function(f,b,e,v,n,t,s){if(f.fbq)return;n=f.fbq=function(){n.callMethod?n.callMethod.apply(n,arguments):n.queue.push(arguments)};if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';n.queue=[];t=b.createElement(e);t.async=!0;t.src='https://connect.facebook.net/en_US/fbevents.js';s=b.getElementsByTagName(e)[0];s.parentNode.insertBefore(t,s)}(window,document,'script');
        PIXELS_TO_TRACK.forEach(p => { fbq('init', p.id); });
        fbq('track', 'PageView');
    <\/script>
    <noscript>${noscriptPixelsString}</noscript>
</head>
<body><p>Redirecionando...</p></body>
</html>`;
        
        const modalContent = `<textarea readonly class="form-input w-full h-64 text-xs">${code.trim()}</textarea>`;
        document.getElementById('modal-container').innerHTML = this.templates.modal('Código da Pressel Gerado', modalContent);
    };

    // INICIA A APLICAÇÃO
    App.init();
    </script>
</body>
</html>
