<!DOCTYPE html>
<html lang="pt-BR" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>HotTrack SAAS • Futurista</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Orbitron:wght@500;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#020617; /* slate-950 */
      --panel: rgba(2,6,23,.6);
      --stroke: rgba(56,189,248,.25); /* sky-400 */
      --neon:#22d3ee; /* cyan-400 */
      --muted:#94a3b8;
      --text:#e2e8f0;
    }
    html,body{height:100%}
    body{
      font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      color:var(--text);
      background: radial-gradient(1200px 600px at 10% -10%, rgba(34,211,238,.08), transparent 40%),
                  radial-gradient(800px 400px at 110% 10%, rgba(56,189,248,.10), transparent 45%),
                  var(--bg);
      background-attachment: fixed;
      overflow: hidden;
    }
    /* sutil grid neon */
    body:before{
      content:""; position:fixed; inset:0; pointer-events:none; opacity:.25;
      background-image: linear-gradient(to right, rgba(148,163,184,.08) 1px, transparent 1px),
                        linear-gradient(to bottom, rgba(148,163,184,.06) 1px, transparent 1px);
      background-size: 24px 24px;
      mask-image: radial-gradient(60% 60% at 50% 40%, #000 65%, transparent 100%);
      z-index:0;
    }
    .glass{
      background: var(--panel);
      backdrop-filter: blur(14px) saturate(120%);
      -webkit-backdrop-filter: blur(14px) saturate(120%);
      border: 1px solid var(--stroke);
      box-shadow: 0 0 0 1px rgba(2,6,23,.4) inset, 0 10px 30px rgba(0,0,0,.35);
    }
    .btn{
      background: linear-gradient(180deg, #0ea5e9, #0284c7);
      color:#fff; border:1px solid #38bdf8; border-radius:.75rem; padding:.75rem 1rem;
      box-shadow: 0 0 10px rgba(14,165,233,.35), inset 0 0 6px rgba(255,255,255,.15);
      transition: transform .15s ease, box-shadow .2s ease, filter .2s ease;
    }
    .btn:hover{ transform: translateY(-1px); box-shadow:0 0 22px rgba(56,189,248,.6); filter:saturate(115%)}
    .btn:disabled{ opacity:.6; cursor:not-allowed; transform:none; box-shadow:none }
    .btn-red{ background: linear-gradient(180deg, #ef4444, #b91c1c); border-color:#f87171 }
    .btn-red:hover{ box-shadow:0 0 22px rgba(239,68,68,.6) }
    .inp{ background: rgba(15,23,42,.6); border:1px solid #334155; color:#e2e8f0; border-radius:.75rem; padding:.65rem .85rem; transition:border-color .2s, box-shadow .2s }
    .inp:focus{ outline:none; border-color:#38bdf8; box-shadow:0 0 0 4px rgba(56,189,248,.18) }
    .nav-link{ color:var(--muted); border-left:3px solid transparent; border-radius:.5rem; padding:.65rem .75rem; display:flex; align-items:center; gap:.6rem; cursor:pointer; transition:all .2s }
    .nav-link:hover{ background: rgba(56,189,248,.08); color:#fff; border-left-color:#38bdf8 }
    .nav-link.active{ background: rgba(14,165,233,.14); color:#fff; border-left-color:#0ea5e9; font-weight:600 }
    .modal{ display:none }
    .modal.active{ display:flex; position:fixed; inset:0; z-index:50; align-items:center; justify-content:center; background:rgba(2,6,23,.7); backdrop-filter:blur(10px) }
    .fade-in{ animation:fade-in .35s ease both }
    @keyframes fade-in{ from{ opacity:0; transform: translateY(6px) } to{ opacity:1; transform:none }}
    .topbar-gradient{ background: radial-gradient(120% 160% at 10% -40%, rgba(34,211,238,.20), transparent 40%), linear-gradient(90deg, rgba(2,6,23,.75), rgba(2,6,23,.35), rgba(2,6,23,.75)) }
    .chip{ font-family: 'Orbitron', monospace; letter-spacing:.06em; color:#67e8f9 }
    @media (prefers-reduced-motion: reduce){ .fade-in{animation:none} .btn:hover{transform:none} }
  </style>
</head>
<body class="relative">
  <!-- Aura neon -->
  <div class="pointer-events-none absolute -top-24 right-[-10%] h-[38rem] w-[38rem] rounded-full blur-3xl opacity-25"
       style="background: radial-gradient(circle, rgba(56,189,248,.35), transparent 55%)"></div>

  <div id="app" class="relative z-10"></div>
  <div id="modal-container" class="relative z-20"></div>

  <script>
  const App = {
    state: {
      API_BASE_URL: 'https://hottrack.vercel.app',
      token: null,
      data: { pixels: [], bots: [], pressels: [], settings: {} },
      currentPage: 'pressels',
    },

    async init(){
      // Recupera token e página atual
      this.state.token = localStorage.getItem('hottrack_token');
      const storedPage = localStorage.getItem('hottrack_current_page');
      if (storedPage) this.state.currentPage = storedPage;

      const root = document.getElementById('app');
      root.innerHTML = `
        <div class="h-screen grid place-items-center">
          <div class="glass rounded-2xl p-6 fade-in">
            <div class="flex items-center gap-3">
              <svg class="h-6 w-6 text-cyan-300" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 13.5l10.5-11.25L12 10.5h8.25L9.75 21.75 12 13.5H3.75z"/></svg>
              <span class="chip text-sm">INICIALIZANDO</span>
            </div>
          </div>
        </div>`;

      if (this.state.token){
        try{
          this.state.data = await this.apiRequest('/api/dashboard/data');
          this.renderLayout();
        }catch(e){ this.logout(); }
      } else {
        this.renderAuth();
      }
    },

    // ===== UI =====
    renderAuth(page='login'){
      document.getElementById('app').innerHTML = this.ui.auth(page);
      this.bindAuthEvents();
    },

    renderLayout(){
      document.getElementById('app').innerHTML = this.ui.layout();
      this.navigateTo(this.state.currentPage);
      this.bindDashboardEvents();
    },

    ui: {
      auth(page='login'){
        return `
          <div class="min-h-screen p-4 grid place-items-center">
            <div class="w-full max-w-md glass rounded-2xl p-8 fade-in">
              <div class="flex items-center justify-center gap-2 mb-6">
                <svg class="h-8 w-8 text-cyan-300" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 13.5l10.5-11.25L12 10.5h8.25L9.75 21.75 12 13.5H3.75z"/></svg>
                <h1 class="text-2xl font-bold" style="font-family:Orbitron,Inter">HotTrack</h1>
              </div>
              ${page==='login' ? this.login() : this.register()}
            </div>
          </div>`;
      },
      login(){
        return `
          <h2 class="text-xl font-semibold">Acessar Plataforma</h2>
          <form id="loginForm" class="space-y-5 mt-6">
            <div>
              <label class="text-sm text-slate-300">E-mail</label>
              <input name="email" type="email" required class="inp w-full mt-1" autocomplete="email" />
            </div>
            <div>
              <label class="text-sm text-slate-300">Senha</label>
              <input name="password" type="password" required class="inp w-full mt-1" autocomplete="current-password" />
            </div>
            <button class="btn w-full font-semibold">Entrar</button>
          </form>
          <div class="text-center mt-6">
            <a href="#" id="goRegister" class="text-sm text-cyan-300 hover:underline">Não tem uma conta? Cadastre-se</a>
          </div>`
      },
      register(){
        return `
          <h2 class="text-xl font-semibold">Criar Conta</h2>
          <form id="registerForm" class="space-y-5 mt-6">
            <div>
              <label class="text-sm text-slate-300">Nome</label>
              <input name="name" required class="inp w-full mt-1" />
            </div>
            <div>
              <label class="text-sm text-slate-300">E-mail</label>
              <input name="email" type="email" required class="inp w-full mt-1" autocomplete="email" />
            </div>
            <div>
              <label class="text-sm text-slate-300">Senha</label>
              <input name="password" type="password" minlength="8" required class="inp w-full mt-1" autocomplete="new-password" />
            </div>
            <button class="btn w-full font-semibold">Criar Conta</button>
          </form>
          <div class="text-center mt-6">
            <a href="#" id="goLogin" class="text-sm text-cyan-300 hover:underline">Já tem uma conta? Faça login</a>
          </div>`
      },

      // layout principal com topbar
      layout(){
        return `
        <div class="h-screen grid grid-rows-[auto,1fr]">
          <header class="topbar-gradient border-b border-slate-800/60 px-4 md:px-6 py-3 flex items-center justify-between">
            <div class="flex items-center gap-3">
              <button id="sidebarToggle" class="md:hidden btn px-3 py-2">Menu</button>
              <div class="flex items-center gap-2">
                <svg class="h-6 w-6 text-cyan-300" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 13.5l10.5-11.25L12 10.5h8.25L9.75 21.75 12 13.5H3.75z"/></svg>
                <span class="chip text-xs">HOTTRACK • SAAS</span>
              </div>
            </div>
            <div class="flex items-center gap-2">
              <div class="text-xs text-slate-300 hidden sm:block" id="clock"></div>
              <button id="logoutButton" class="btn-red px-3 py-2 rounded-lg">Sair</button>
            </div>
          </header>
          <div class="grid grid-cols-1 md:grid-cols-[16rem,1fr] h-full overflow-hidden">
            <aside id="sidebar" class="glass md:static fixed inset-y-0 -left-full md:left-0 w-64 md:w-auto z-30 transition-all duration-200 p-4 flex flex-col">
              <div class="text-center mb-8 mt-2">
                <h1 class="text-lg font-semibold" style="font-family:Orbitron,Inter">Painel</h1>
              </div>
              <nav id="sidebarNav" class="flex flex-col gap-2">
                <div data-target="pressels" class="nav-link"><span>⚡</span> Criador de Pressel</div>
                <div data-target="pixels" class="nav-link"><span>🧩</span> Gerenciar Pixels</div>
                <div data-target="bots" class="nav-link"><span>🤖</span> Gerenciar Bots</div>
                <div data-target="settings" class="nav-link"><span>💳</span> API PIX</div>
              </nav>
              <div class="mt-auto text-xs text-slate-400">v1.1 • UI Futurista</div>
            </aside>
            <main id="content" class="overflow-y-auto p-5 md:p-8"></main>
          </div>
        </div>`
      },

      // páginas
      pixels(){
        const items = (App.state.data.pixels||[]).map(p=>`
          <div class="glass p-3 rounded-xl flex justify-between items-center">
            <span class="text-sm">${p.account_name}</span>
            <button data-id="${p.id}" class="delete-pixel-btn btn-red text-xs px-3 py-1 rounded-lg">Excluir</button>
          </div>`).join('');
        return `
        <section class="fade-in space-y-6">
          <h1 class="text-2xl font-semibold">Gerenciar Pixels</h1>
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 items-start">
            <div class="glass p-6 rounded-2xl">
              <h2 class="text-lg font-semibold mb-4">Adicionar Pixel</h2>
              <form id="pixelForm" class="space-y-3">
                <input name="account_name" placeholder="Nome do Pixel (Ex: Produto Y)" class="inp w-full" required />
                <input name="pixel_id" placeholder="ID do Pixel da Meta" class="inp w-full" required />
                <textarea name="meta_api_token" placeholder="Token da API de Conversões" rows="2" class="inp w-full"></textarea>
                <button class="btn w-full">Adicionar Pixel</button>
              </form>
            </div>
            <div class="glass p-6 rounded-2xl">
              <h2 class="text-lg font-semibold mb-4">Pixels Salvos</h2>
              <div id="pixel-list" class="space-y-2">${items || '<p class="text-slate-400 text-sm">Nenhum pixel salvo.</p>'}</div>
            </div>
          </div>
        </section>`
      },

      bots(){
        const items = (App.state.data.bots||[]).map(b=>`
          <div class="glass p-3 rounded-xl flex justify-between items-center">
            <span class="text-sm">${b.bot_name}</span>
            <button data-id="${b.id}" class="delete-bot-btn btn-red text-xs px-3 py-1 rounded-lg">Excluir</button>
          </div>`).join('');
        return `
        <section class="fade-in space-y-6">
          <h1 class="text-2xl font-semibold">Gerenciar Bots</h1>
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 items-start">
            <div class="glass p-6 rounded-2xl">
              <h2 class="text-lg font-semibold mb-4">Adicionar Bot</h2>
              <form id="botForm" class="space-y-3">
                <input name="bot_name" placeholder="Username do Bot (sem @)" class="inp w-full" required />
                <input name="bot_token" placeholder="Token do Bot (do BotFather)" class="inp w-full" required />
                <button class="btn w-full">Adicionar Bot</button>
              </form>
            </div>
            <div class="glass p-6 rounded-2xl">
              <h2 class="text-lg font-semibold mb-4">Bots Salvos</h2>
              <div id="bot-list" class="space-y-2">${items || '<p class="text-slate-400 text-sm">Nenhum bot salvo.</p>'}</div>
            </div>
          </div>
        </section>`
      },

      pressels(){
        const { pixels, bots, pressels } = App.state.data;
        const botOptions = (bots||[]).map(b=>`<option value="${b.id}">${b.bot_name}</option>`).join('');
        const pixelChecks = (pixels||[]).map(p=>`
          <label class="flex items-center gap-2 text-slate-300 hover:text-white">
            <input type="checkbox" name="pixel_ids" value="${p.id}" class="h-4 w-4 rounded bg-slate-800 border-slate-600 text-cyan-400 focus:ring-cyan-500"/>
            <span>${p.account_name}</span>
          </label>`).join('');
        const list = (pressels||[]).map(pr=>`
          <div class="glass p-3 rounded-xl flex justify-between items-center text-sm">
            <div>
              <p class="font-semibold">${pr.name}</p>
              <p class="text-xs text-slate-400">Bot: ${pr.bot_name}</p>
            </div>
            <div class="flex gap-2">
              <button data-id="${pr.id}" class="generate-code-btn btn text-xs px-3 py-1">Ver Código</button>
              <button data-id="${pr.id}" class="delete-pressel-btn btn-red text-xs px-3 py-1">Excluir</button>
            </div>
          </div>`).join('');

        return `
        <section class="fade-in space-y-6">
          <h1 class="text-2xl font-semibold">Criador de Pressel</h1>
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 items-start">
            <div class="glass p-6 rounded-2xl">
              <h2 class="text-lg font-semibold mb-4">Criar Nova Pressel</h2>
              <form id="presselForm" class="space-y-4">
                <input name="name" placeholder="Nome da Pressel" class="inp w-full" required />
                <input name="white_page_url" type="url" placeholder="URL da Página Branca (Fallback)" class="inp w-full" required />
                <select name="bot_id" class="inp w-full" required><option value="">Selecione um Bot</option>${botOptions}</select>
                <div class="glass p-3 rounded-xl">
                  <p class="font-semibold mb-2">Selecione os Pixels:</p>
                  <div class="space-y-2">${pixelChecks || '<p class="text-slate-400 text-sm">Cadastre um pixel primeiro.</p>'}</div>
                </div>
                <button class="btn w-full font-bold">Salvar e Gerar Código</button>
              </form>
            </div>
            <div class="glass p-6 rounded-2xl">
              <h2 class="text-lg font-semibold mb-4">Pressels Criadas</h2>
              <div id="pressel-list" class="space-y-3">${list || '<p class="text-slate-400 text-sm">Nenhuma pressel criada.</p>'}</div>
            </div>
          </div>
        </section>`
      },

      settings(){
        const tok = App.state.data?.settings?.pushinpay_token || '';
        return `
        <section class="fade-in space-y-6 max-w-xl">
          <h1 class="text-2xl font-semibold">Configuração da API PIX</h1>
          <div class="glass p-6 rounded-2xl">
            <h2 class="text-lg font-semibold mb-2">PushinPay</h2>
            <p class="text-sm text-slate-300 mb-4">Cole o seu Bearer Token para gerar cobranças PIX no bot.</p>
            <form id="pushinpayForm" class="space-y-4">
              <input name="token" value="${tok}" placeholder="Cole seu token aqui" class="inp w-full" />
              <button class="btn w-full">Salvar Token</button>
            </form>
          </div>
        </section>`
      },

      modal(title, content){
        return `
        <div id="modal" class="modal active" role="dialog" aria-modal="true">
          <div class="glass w-[min(92vw,820px)] rounded-2xl p-6 fade-in relative">
            <div class="flex items-center justify-between mb-4">
              <h2 class="text-lg font-semibold">${title}</h2>
              <button id="closeModalBtn" class="text-slate-300 hover:text-white text-2xl" aria-label="Fechar">&times;</button>
            </div>
            ${content}
          </div>
        </div>`
      }
    },

    // ===== Event binding =====
    bindAuthEvents(){
      const root = document.getElementById('app');
      root.addEventListener('click', (e)=>{
        if(e.target.id==='goRegister'){ e.preventDefault(); this.renderAuth('register'); }
        if(e.target.id==='goLogin'){ e.preventDefault(); this.renderAuth('login'); }
      });
      root.addEventListener('submit', async (e)=>{
        e.preventDefault();
        const f = e.target; const data = Object.fromEntries(new FormData(f).entries());
        if(f.id==='loginForm') await this.login(data.email, data.password);
        if(f.id==='registerForm') await this.register(data.name, data.email, data.password);
      });
    },

    bindDashboardEvents(){
      const app = document.getElementById('app');

      // Relógio simples no topbar
      const clockEl = document.getElementById('clock');
      if(clockEl){ this.clockInterval && clearInterval(this.clockInterval); this.clockInterval = setInterval(()=>{ clockEl.textContent = new Date().toLocaleString('pt-BR'); }, 1000); }

      app.addEventListener('click', async (e)=>{
        if(e.target.id==='logoutButton') return this.logout();
        if(e.target.id==='sidebarToggle'){
          const sb = document.getElementById('sidebar');
          sb.style.left = sb.style.left === '0px' ? '-100%' : '0px';
          return;
        }
        if(e.target.id==='closeModalBtn' || e.target.classList.contains('modal')){
          document.getElementById('modal-container').innerHTML = '';
          return;
        }

        const link = e.target.closest('.nav-link');
        if(link){ this.navigateTo(link.dataset.target); return; }

        if(e.target.classList.contains('generate-code-btn')){
          const id = e.target.dataset.id;
          const pr = this.state.data.pressels.find(p=> String(p.id)===String(id));
          if(pr) this.generatePresselCode(pr);
          return;
        }

        if(e.target.id==='copyCodeBtn'){
          const tx = document.getElementById('presselCode');
          const text = tx?.value || '';
          if (navigator.clipboard?.writeText) {
            navigator.clipboard.writeText(text).then(()=>{ e.target.textContent='Copiado!'; setTimeout(()=> e.target.textContent='Copiar Código', 1600); });
          } else {
            tx.select(); document.execCommand('copy'); e.target.textContent='Copiado!'; setTimeout(()=> e.target.textContent='Copiar Código', 1600);
          }
          return;
        }

        if(e.target.classList.contains('delete-pixel-btn') || e.target.classList.contains('delete-bot-btn') || e.target.classList.contains('delete-pressel-btn')){
          const id = e.target.dataset.id; let type='', endpoint='';
          if(e.target.classList.contains('delete-pixel-btn')){ type='pixels'; endpoint='pixels'; }
          if(e.target.classList.contains('delete-bot-btn')){ type='bots'; endpoint='bots'; }
          if(e.target.classList.contains('delete-pressel-btn')){ type='pressels'; endpoint='pressels'; }
          if(confirm('Tem certeza que deseja excluir este item?')){
            try{
              await this.apiRequest(`/api/${endpoint}/${id}`, 'DELETE');
              this.state.data[type] = this.state.data[type].filter(item=> String(item.id)!==String(id));
              this.navigateTo(this.state.currentPage);
              this.toast('Item excluído com sucesso!','success');
            }catch(err){}
          }
        }
      });

      app.addEventListener('submit', async (e)=>{
        e.preventDefault();
        const form = e.target; const btn = form.querySelector('button[type="submit"], button:not([type])') || form.querySelector('button');
        const original = btn ? btn.innerHTML : '';
        if(btn){ btn.innerHTML = 'Salvando...'; btn.disabled = true; }
        const data = Object.fromEntries(new FormData(form).entries());
        try{
          let okToast = true;
          if(form.id==='pixelForm'){
            const created = await this.apiRequest('/api/pixels','POST',data);
            if(created){ this.state.data.pixels.unshift(created); this.navigateTo('pixels'); }
          }
          if(form.id==='botForm'){
            const created = await this.apiRequest('/api/bots','POST',data);
            if(created){ this.state.data.bots.unshift(created); this.navigateTo('bots'); }
          }
          if(form.id==='presselForm'){
            const pixel_ids = Array.from(form.querySelectorAll('input[name="pixel_ids"]:checked')).map(cb=>cb.value);
            if(pixel_ids.length===0){ this.toast('Selecione ao menos um pixel.','error'); okToast=false; }
            else {
              const payload = {...data, pixel_ids};
              const created = await this.apiRequest('/api/pressels','POST',payload);
              if(created){ this.state.data.pressels.unshift(created); this.navigateTo('pressels'); this.generatePresselCode(created); }
            }
          }
          if(form.id==='pushinpayForm'){
            await this.apiRequest('/api/settings/pushinpay','POST',{ token:data.token });
            if(!this.state.data.settings) this.state.data.settings = {};
            this.state.data.settings.pushinpay_token = data.token;
            this.toast('Token salvo com sucesso!','success');
            okToast=false;
          }
          if(okToast) this.toast('Salvo com sucesso!','success');
        }catch(err){}
        finally{ if(btn){ btn.innerHTML = original; btn.disabled = false; } }
      });

      // fecha modal com ESC
      window.addEventListener('keydown', (ev)=>{
        if(ev.key==='Escape'){ const modal = document.getElementById('modal'); if(modal) document.getElementById('modal-container').innerHTML=''; }
      });
    },

    // ===== Helpers =====
    async apiRequest(endpoint, method='GET', body=null){
      try{
        const headers = { 'Content-Type':'application/json' };
        if(this.state.token) headers['Authorization'] = `Bearer ${this.state.token}`;
        const res = await fetch(`${this.state.API_BASE_URL}${endpoint}`, { method, headers, body: body? JSON.stringify(body): undefined });

        if(res.status===204) return null;
        const contentType = res.headers.get('content-type') || '';
        let data;
        if(contentType.includes('application/json')){
          data = await res.json();
        } else {
          const text = await res.text();
          try{ data = JSON.parse(text) }catch{ data = { message: text } }
        }
        if(!res.ok) throw new Error(data?.message || 'Erro inesperado');
        return data;
      }catch(err){
        this.toast(err.message || 'Erro de rede','error');
        if(/inválido|Token/i.test(err.message)) this.logout();
        throw err;
      }
    },

    login(email,password){
      return this.apiRequest('/api/sellers/login','POST',{email,password}).then(data=>{
        this.state.token = data.token;
        localStorage.setItem('hottrack_token', data.token);
        this.init();
      });
    },

    register(name,email,password){
      return this.apiRequest('/api/sellers/register','POST',{name,email,password}).then(data=>{
        this.toast(data.message || 'Cadastro realizado! Faça o login.','success');
        this.renderAuth('login');
      });
    },

    logout(){
      this.state.token = null;
      localStorage.removeItem('hottrack_token');
      localStorage.removeItem('hottrack_current_page');
      this.init();
    },

    navigateTo(page){
      this.state.currentPage = page;
      localStorage.setItem('hottrack_current_page', page);
      const content = document.getElementById('content');
      if(content && this.ui[page]){
        content.innerHTML = this.ui[page]();
        document.querySelectorAll('.nav-link').forEach(el=> el.classList.toggle('active', el.dataset.target===page));
      }
    },

    generatePresselCode(pressel){
      const { settings, pixels } = this.state.data;
      const sellerApiKey = settings?.api_key;
      if(!sellerApiKey){ this.toast('Erro: API Key do vendedor não encontrada. Configure nas "Configurações".', 'error'); return; }

      // Garante comparação correta entre IDs string/number
      const selectedPixels = (pixels||[]).filter(p => (pressel.pixel_ids||[]).map(String).includes(String(p.id)));
      const pixelsToTrackString = JSON.stringify(selectedPixels.map(p=>({ id: p.pixel_id })), null, 2);
      const noscriptPixelsString = selectedPixels.map(p=>`<img height="1" width="1" style="display:none" src="https://www.facebook.com/tr?id=${p.pixel_id}&ev=PageView&noscript=1"/>`).join('\n    ');

      const code = `<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>${pressel.name}</title>
  <script>
    const API_BASE_URL='${this.state.API_BASE_URL}';
    const SELLER_API_KEY='${sellerApiKey}';
    const PRESSEL_ID=${pressel.id};
    const TELEGRAM_USERNAME='${pressel.bot_name}';
    const WHITE_PAGE_URL='${pressel.white_page_url}';
    const PIXELS_TO_TRACK=${pixelsToTrackString};

    const isBot=()=>/bot|facebook|crawler|spider|preview/i.test(navigator.userAgent),isMobile=()=>/android|iphone|ipad|ipod/i.test(navigator.userAgent);
    async function handleRedirect(){
      if(isBot()||!isMobile()){ location.replace(WHITE_PAGE_URL); return }
      try{
        const q=new URLSearchParams(location.search);
        const res=await fetch(`${this.state?.API_BASE_URL || ''}/api/registerClick`.replace('undefined','${this.state.API_BASE_URL}'),{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({sellerApiKey:SELLER_API_KEY,presselId:PRESSEL_ID,referer:document.referrer||null,fbclid:q.get('fbclid')||null,fbp:document.cookie.match(/_fbp=([^;]+)/)?.[1]||null,fbc:document.cookie.match(/_fbc=([^;]+)/)?.[1]||null,user_agent:navigator.userAgent})});
        const json=await res.json();
        if(res.ok && json?.status==='success') location.replace(`https://t.me/${'${'}TELEGRAM_USERNAME${'}'}?start=${'${'}json.click_id${'}'}`);
        else location.replace(WHITE_PAGE_URL);
      }catch(e){ location.replace(WHITE_PAGE_URL) }
    }
    handleRedirect();
  <\/script>
  <script>
    !function(f,b,e,v,n,t,s){if(f.fbq)return;n=f.fbq=function(){n.callMethod?n.callMethod.apply(n,arguments):n.queue.push(arguments)};if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';n.queue=[];t=b.createElement(e);t.async=!0;t.src='https://connect.facebook.net/en_US/fbevents.js';s=b.getElementsByTagName(e)[0];s.parentNode.insertBefore(t,s)}(window,document,'script');
    PIXELS_TO_TRACK.forEach(p=>fbq('init', p.id));
    fbq('track','PageView');
  <\/script>
  <noscript>${noscriptPixelsString}</noscript>
</head>
<body><p>Redirecionando...</p></body>
</html>`;

      const modalContainer = document.getElementById('modal-container');
      const escape = (str)=> String(str).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
      const modalContent = `
        <textarea id="presselCode" readonly class="inp w-full h-80 text-xs" style="font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace">${escape(code)}</textarea>
        <div class="mt-4 flex items-center justify-between gap-2">
          <span class="text-xs text-slate-400">Cole no <strong>HEAD</strong> de uma página em branco.</span>
          <button id="copyCodeBtn" class="btn">Copiar Código</button>
        </div>`;
      modalContainer.innerHTML = this.ui.modal('Código da Pressel Gerado', modalContent);
    },

    toast(msg, type='success'){
      const id = `t_${crypto.randomUUID?.() || Math.random().toString(36).slice(2)}`;
      const el = document.createElement('div');
      el.id = id;
      el.className = `fixed bottom-5 right-5 z-50 px-4 py-3 rounded-xl text-sm fade-in ${type==='error' ? 'bg-red-600' : 'bg-emerald-600'}`;
      el.textContent = msg;
      document.body.appendChild(el);
      setTimeout(()=>{
        const node = document.getElementById(id); if(!node) return; node.style.transition='all .3s'; node.style.opacity='0'; node.style.transform='translateY(8px)'; setTimeout(()=> node.remove(), 280);
      }, 3000);
    }
  };

  App.init();
  </script>
</body>
</html>
